<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Electron boilerplate</title>
		<link rel="stylesheet" href="index.css" />
	</head>
	<body>
		<div class="container">
			<form id="completion-box__form">
				<input type="text" id="completion-box__input" autofocus />
			</form>
		</div>

		<script>
			const autocomplete = require("autocompleter");
			const { exec } = require("child_process");
			const COMPLETION_BOX_DICT = "COMPLETION_BOX_DICT";

			const completionBoxDict = JSON.parse(
				window.localStorage.getItem(COMPLETION_BOX_DICT) || "[]"
			);

			const input = document.getElementById("completion-box__input");
			const form = document.getElementById("completion-box__form");

			function typeItem(itemLabel) {
				exec(
					`xdotool keydown alt key Tab key Left key Left; sleep 0.3; xdotool keyup alt && sleep 0.3 && xdotool type "${itemLabel}"`,
					(error, data, getter) => {
						if (error) {
							console.log("error", error.message);
							return;
						}
						if (getter) {
							console.log("data", data);
							return;
						}
						console.log("data", data);
						window.close();
					}
				);
			}

			function storeInputCount(event) {
				event.preventDefault();
				console.log(input.value);

				if (
					completionBoxDict.findIndex((item) => item.value === input.value) ===
					-1
				) {
					completionBoxDict.push({
						label: input.value,
						value: input.value,
					});
				}

				window.localStorage.setItem(
					COMPLETION_BOX_DICT,
					JSON.stringify(completionBoxDict)
				);
				typeItem(input.value);
				input.value = "";
			}

			form.addEventListener("submit", storeInputCount);

			autocomplete({
				input: input,
				fetch: function (text, update) {
					text = text.toLowerCase();
					const suggestions = completionBoxDict.filter((n) =>
						n.label.toLowerCase().startsWith(text)
					);
					update(suggestions);
				},
				onSelect: function (item) {
					input.value = item.label;
					console.log(item);
				},
			});
		</script>
	</body>
</html>
